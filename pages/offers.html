<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title id="pageTitle">Current Offers | Maxnate Africa</title>
  <link rel="stylesheet" href="../assets/css/main.css" />
  <meta name="description" content="Latest technology service offers from Maxnate Africa." id="pageDescription" />
</head>
<body>
  <header class="page-header" style="padding:2rem 0 0; text-align:center;">
    <h1 class="section-title" id="headerTitle">Latest Offers</h1>
    <p class="section-subtitle" id="headerSubtitle">Claim exclusive, timeâ€‘limited technology service discounts.</p>
  </header>

  <main class="offers-page container">
    <div id="offersContainer" class="offers-grid" aria-live="polite"></div>
    <div id="offersEmpty" class="empty-offers" style="display:none;">No active offers right now. Check back soon.</div>
  </main>

  <!-- Active Offer Overlay injected dynamically -->
  <div id="offerOverlayMount"></div>

  <!-- Content service -->
  <script src="../assets/js/content-service.js"></script>

  <script>
    let WHATSAPP_NUMBER = '255746662612';
    let pageSettings = null;

    // Load page settings
    async function loadPageSettings() {
      try {
        const response = await fetch('/assets/data/offers-page.json');
        if (response.ok) {
          pageSettings = await response.json();
          
          // Update page metadata and content
          if (pageSettings.title) {
            document.getElementById('pageTitle').textContent = `${pageSettings.title} | Maxnate Africa`;
          }
          if (pageSettings.metaDescription) {
            document.getElementById('pageDescription').setAttribute('content', pageSettings.metaDescription);
          }
          if (pageSettings.headerTitle) {
            document.getElementById('headerTitle').textContent = pageSettings.headerTitle;
          }
          if (pageSettings.headerSubtitle) {
            document.getElementById('headerSubtitle').textContent = pageSettings.headerSubtitle;
          }
          if (pageSettings.emptyMessage) {
            document.getElementById('offersEmpty').textContent = pageSettings.emptyMessage;
          }
          if (pageSettings.whatsappNumber) {
            WHATSAPP_NUMBER = pageSettings.whatsappNumber;
          }
        }
      } catch (error) {
        console.warn('Page settings not found, using defaults:', error);
      }
    }

    function generateOfferCode(id){
      const date = new Date();
      const base = `${date.getFullYear()}${String(date.getMonth()+1).padStart(2,'0')}${String(date.getDate()).padStart(2,'0')}`;
      const short = id.slice(-5).toUpperCase();
      return `OFF-${base}-${short}`;
    }

    function buildWhatsAppLink(offer){
      const code = generateOfferCode(offer.id);
      const msg = `Hello Maxnate Team,%0A%0AI would like to claim offer ${code}.%0AOffer: ${offer.title}%0ADiscount: ${offer.discount || offer.value || ''}%0AService Category: ${offer.category || ''}%0AStatus: Requesting validation.%0A%0AThank you.`;
      return `https://wa.me/${WHATSAPP_NUMBER}?text=${msg}`;
    }

    function renderOfferCard(offer){
      const code = generateOfferCode(offer.id);
      const expiryTxt = offer.expiry ? new Date(offer.expiry).toLocaleDateString() : 'N/A';
      const iconClass = offer.iconAnimation && offer.iconAnimation !== 'none' ? `icon-${offer.iconAnimation}` : 'icon-none';
      const icon = offer.icon || 'ðŸ”¥';
      
      return `<div class="offer-card" data-offer-id="${offer.id}">
        <span class="offer-badge">${offer.discount? 'SAVE' : 'OFFER'}</span>
        <div class="offer-icon ${iconClass}">${icon}</div>
        <div class="offer-discount">${offer.discount || offer.value || ''}</div>
        <h3 class="offer-title">${offer.title}</h3>
        <p class="offer-desc">${offer.description || ''}</p>
        <div class="offer-meta">
          <span class="offer-code">${code}</span>
          <span class="offer-expiry">Expires: ${expiryTxt}</span>
        </div>
        <div class="offer-actions">
          <a class="offer-claim-btn" href="${buildWhatsAppLink(offer)}" target="_blank" rel="noopener" aria-label="Claim ${code} on WhatsApp">
            <span>Claim via WhatsApp</span>
          </a>
        </div>
      </div>`;
    }

    function injectOverlay(offer){
      const mount = document.getElementById('offerOverlayMount');
      if (!mount) return;
      const code = generateOfferCode(offer.id);
      const expiryTxt = offer.expiry ? new Date(offer.expiry).toLocaleDateString() : '';
      mount.innerHTML = `<div class="active-offer-overlay" role="dialog" aria-label="Active Offer" aria-live="assertive">
        <div class="active-offer-header">
          <h4>ðŸ”¥ Limited Offer <button class="active-offer-close" aria-label="Close offer" onclick="document.querySelector('.active-offer-overlay').remove()">&times;</button></h4>
        </div>
        <div class="active-offer-body">
          <p><strong>${offer.title}</strong></p>
          <p>${offer.description || ''}</p>
          <div class="active-offer-actions">
            <a class="active-offer-claim" href="${buildWhatsAppLink(offer)}" target="_blank" rel="noopener">Claim <span class="active-offer-code">${code}</span></a>
            <span class="active-offer-expiry">${expiryTxt ? 'Expires '+expiryTxt : ''}</span>
          </div>
        </div>
      </div>`;
    }

    function injectJsonLd(offers){
      if (!offers || !offers.length) return;
      const active = offers.filter(o => (o.status||'draft')==='published');
      if (!active.length) return;
      const nowIso = new Date().toISOString();
      const offerEntities = active.map(o => {
        const validThrough = o.expiry ? new Date(o.expiry).toISOString() : undefined;
        return {
          '@type': 'Offer',
          name: o.title,
          description: o.description || '',
          url: 'https://www.maxnate.com/offers',
          sku: o.id,
          priceCurrency: 'USD',
          price: typeof o.price === 'number' ? o.price : (typeof o.value === 'number' ? o.value : '0'),
          availability: 'https://schema.org/InStock',
          validFrom: nowIso,
          ...(validThrough ? { validThrough } : {}),
          identifier: generateOfferCode(o.id)
        };
      });
      const aggregate = {
        '@context': 'https://schema.org',
        '@type': 'AggregateOffer',
        url: 'https://www.maxnate.com/offers',
        offerCount: offerEntities.length,
        offers: offerEntities,
        lowPrice: offerEntities.reduce((min, o) => {
          const p = parseFloat(o.price) || 0; return p < min ? p : min;
        }, offerEntities[0] ? parseFloat(offerEntities[0].price)||0 : 0),
        highPrice: offerEntities.reduce((max, o) => {
          const p = parseFloat(o.price) || 0; return p > max ? p : max;
        }, offerEntities[0] ? parseFloat(offerEntities[0].price)||0 : 0),
        priceCurrency: 'USD'
      };
      const script = document.createElement('script');
      script.type = 'application/ld+json';
      script.textContent = JSON.stringify(aggregate);
      document.head.appendChild(script);
    }

    async function loadOffers(){
      const container = document.getElementById('offersContainer');
      const empty = document.getElementById('offersEmpty');
      
      try {
        const offers = await window.contentService.getOffers({ limit: 12 });
        const active = offers.filter(o=> (o.status||'draft')==='published');
        
        if (!active.length){ 
          empty.style.display='block'; 
          return; 
        }
        
        container.innerHTML = active.map(renderOfferCard).join('');
        injectJsonLd(active);
        const now = Date.now();
        const first = active.find(o=> !o.expiry || new Date(o.expiry).getTime() > now);
        if (first) injectOverlay(first);
      } catch (error) {
        console.error('Failed to load offers:', error);
        empty.style.display='block';
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await loadPageSettings();
      await loadOffers();
    });
  </script>
</body>
</html>